import math

optimal_waypoints = ([[-5.07720415e+00,  6.00905286e+00],
       [-4.93465034e+00,  6.02452393e+00],
       [-4.79128718e+00,  6.03557830e+00],
       [-4.64743079e+00,  6.04229140e+00],
       [-4.50340885e+00,  6.04468382e+00],
       [-4.35956033e+00,  6.04271773e+00],
       [-4.21623548e+00,  6.03629718e+00],
       [-4.07379596e+00,  6.02527205e+00],
       [-3.93261477e+00,  6.00944524e+00],
       [-3.79307557e+00,  5.98858274e+00],
       [-3.65557126e+00,  5.96242576e+00],
       [-3.52050149e+00,  5.93070435e+00],
       [-3.38826889e+00,  5.89315180e+00],
       [-3.25927401e+00,  5.84951901e+00],
       [-3.13390891e+00,  5.79958829e+00],
       [-3.01254942e+00,  5.74318584e+00],
       [-2.89554660e+00,  5.68019232e+00],
       [-2.78321734e+00,  5.61055120e+00],
       [-2.67583493e+00,  5.53427436e+00],
       [-2.57361983e+00,  5.45144484e+00],
       [-2.47673132e+00,  5.36221667e+00],
       [-2.38526050e+00,  5.26681200e+00],
       [-2.29922504e+00,  5.16551562e+00],
       [-2.21856605e+00,  5.05866767e+00],
       [-2.14314724e+00,  4.94665475e+00],
       [-2.07275621e+00,  4.82990043e+00],
       [-2.00710794e+00,  4.70885564e+00],
       [-1.94584988e+00,  4.58398968e+00],
       [-1.88856834e+00,  4.45578242e+00],
       [-1.83479581e+00,  4.32471806e+00],
       [-1.78401850e+00,  4.19128065e+00],
       [-1.73568396e+00,  4.05595159e+00],
       [-1.68920787e+00,  3.91920905e+00],
       [-1.64398023e+00,  3.78152919e+00],
       [-1.59937176e+00,  3.64338803e+00],
       [-1.55406858e+00,  3.50304984e+00],
       [-1.50815531e+00,  3.36310758e+00],
       [-1.46105920e+00,  3.22394433e+00],
       [-1.41223727e+00,  3.08594484e+00],
       [-1.36118222e+00,  2.94949986e+00],
       [-1.30742539e+00,  2.81501070e+00],
       [-1.25053912e+00,  2.68289268e+00],
       [-1.19013893e+00,  2.55357686e+00],
       [-1.12588582e+00,  2.42751037e+00],
       [-1.05748823e+00,  2.30515525e+00],
       [-9.84704086e-01,  2.18698593e+00],
       [-9.07342769e-01,  2.07348530e+00],
       [-8.25267124e-01,  1.96513936e+00],
       [-7.38395423e-01,  1.86243074e+00],
       [-6.46703070e-01,  1.76583099e+00],
       [-5.50223807e-01,  1.67579216e+00],
       [-4.49050134e-01,  1.59273781e+00],
       [-3.43332622e-01,  1.51705402e+00],
       [-2.33277847e-01,  1.44908078e+00],
       [-1.19144730e-01,  1.38910422e+00],
       [-1.23920860e-03,  1.33735009e+00],
       [ 1.20092729e-01,  1.29397878e+00],
       [ 2.44473442e-01,  1.25908189e+00],
       [ 3.71503177e-01,  1.23268053e+00],
       [ 5.00770351e-01,  1.21472514e+00],
       [ 6.31862140e-01,  1.20509658e+00],
       [ 7.64374934e-01,  1.20360839e+00],
       [ 8.97924243e-01,  1.21000993e+00],
       [ 1.03215365e+00,  1.22399020e+00],
       [ 1.16674253e+00,  1.24518220e+00],
       [ 1.30141221e+00,  1.27316774e+00],
       [ 1.43593044e+00,  1.30748268e+00],
       [ 1.57011411e+00,  1.34762262e+00],
       [ 1.70383005e+00,  1.39304897e+00],
       [ 1.83699408e+00,  1.44319557e+00],
       [ 1.96956851e+00,  1.49747524e+00],
       [ 2.10155983e+00,  1.55527865e+00],
       [ 2.23301868e+00,  1.61595755e+00],
       [ 2.36400585e+00,  1.67897094e+00],
       [ 2.49460625e+00,  1.74377311e+00],
       [ 2.62491239e+00,  1.80987077e+00],
       [ 2.75638778e+00,  1.87549768e+00],
       [ 2.88833422e+00,  1.93996836e+00],
       [ 3.02081516e+00,  2.00312729e+00],
       [ 3.15392119e+00,  2.06475330e+00],
       [ 3.28773298e+00,  2.12465153e+00],
       [ 3.42233790e+00,  2.18261391e+00],
       [ 3.55779292e+00,  2.23851108e+00],
       [ 3.69412511e+00,  2.29229167e+00],
       [ 3.83133180e+00,  2.34398142e+00],
       [ 3.96938109e+00,  2.39368015e+00],
       [ 4.10821490e+00,  2.44155216e+00],
       [ 4.24775842e+00,  2.48780142e+00],
       [ 4.38793822e+00,  2.53262918e+00],
       [ 4.52869911e+00,  2.57619598e+00],
       [ 4.67000894e+00,  2.61860396e+00],
       [ 4.81184362e+00,  2.65988133e+00],
       [ 4.95412482e+00,  2.69995980e+00],
       [ 5.09661926e+00,  2.73865095e+00],
       [ 5.23896330e+00,  2.77566359e+00],
       [ 5.38092263e+00,  2.81068687e+00],
       [ 5.52242598e+00,  2.84340262e+00],
       [ 5.66348011e+00,  2.87347522e+00],
       [ 5.80410946e+00,  2.90055192e+00],
       [ 5.94433219e+00,  2.92425442e+00],
       [ 6.08415507e+00,  2.94418156e+00],
       [ 6.22357349e+00,  2.95992032e+00],
       [ 6.36257178e+00,  2.97105796e+00],
       [ 6.50112237e+00,  2.97718553e+00],
       [ 6.63918480e+00,  2.97790249e+00],
       [ 6.77670791e+00,  2.97285867e+00],
       [ 6.91363164e+00,  2.96178810e+00],
       [ 7.04988744e+00,  2.94452206e+00],
       [ 7.18539801e+00,  2.92098991e+00],
       [ 7.32007668e+00,  2.89121321e+00],
       [ 7.45382642e+00,  2.85529543e+00],
       [ 7.58653821e+00,  2.81340813e+00],
       [ 7.71808905e+00,  2.76577484e+00],
       [ 7.84833939e+00,  2.71265374e+00],
       [ 7.97713043e+00,  2.65432039e+00],
       [ 8.10428137e+00,  2.59105162e+00],
       [ 8.22958697e+00,  2.52311160e+00],
       [ 8.35281575e+00,  2.45074073e+00],
       [ 8.47370914e+00,  2.37414795e+00],
       [ 8.59198163e+00,  2.29350657e+00],
       [ 8.70732241e+00,  2.20895355e+00],
       [ 8.81939817e+00,  2.12059207e+00],
       [ 8.92785730e+00,  2.02849677e+00],
       [ 9.03233519e+00,  1.93272115e+00],
       [ 9.13246037e+00,  1.83330648e+00],
       [ 9.22786121e+00,  1.73029147e+00],
       [ 9.31817277e+00,  1.62372217e+00],
       [ 9.40304324e+00,  1.51366140e+00],
       [ 9.48213983e+00,  1.40019728e+00],
       [ 9.55515341e+00,  1.28345058e+00],
       [ 9.62180186e+00,  1.16358056e+00],
       [ 9.68183192e+00,  1.04078912e+00],
       [ 9.73501933e+00,  9.15323511e-01],
       [ 9.78116771e+00,  7.87477346e-01],
       [ 9.82010606e+00,  6.57590314e-01],
       [ 9.85168567e+00,  5.26046610e-01],
       [ 9.87577651e+00,  3.93272316e-01],
       [ 9.89226402e+00,  2.59731852e-01],
       [ 9.90104642e+00,  1.25923610e-01],
       [ 9.90203322e+00, -7.62516071e-03],
       [ 9.89514520e+00, -1.40364196e-01],
       [ 9.88031584e+00, -2.71726808e-01],
       [ 9.85749451e+00, -4.01137247e-01],
       [ 9.82665084e+00, -5.28018846e-01],
       [ 9.78778027e+00, -6.51802948e-01],
       [ 9.74091011e+00, -7.71938546e-01],
       [ 9.68610561e+00, -8.87902516e-01],
       [ 9.62347558e+00, -9.99210235e-01],
       [ 9.55317689e+00, -1.10542634e+00],
       [ 9.47541750e+00, -1.20617530e+00],
       [ 9.39045779e+00, -1.30115143e+00],
       [ 9.29860982e+00, -1.39012792e+00],
       [ 9.20023474e+00, -1.47296464e+00],
       [ 9.09573834e+00, -1.54961397e+00],
       [ 8.98556498e+00, -1.62012458e+00],
       [ 8.87019029e+00, -1.68464237e+00],
       [ 8.75011269e+00, -1.74340825e+00],
       [ 8.62584427e+00, -1.79675230e+00],
       [ 8.49790126e+00, -1.84508416e+00],
       [ 8.36679493e+00, -1.88888091e+00],
       [ 8.23302779e+00, -1.92868015e+00],
       [ 8.09710943e+00, -1.96510321e+00],
       [ 7.95941410e+00, -1.99862112e+00],
       [ 7.82016983e+00, -2.02950408e+00],
       [ 7.67959604e+00, -2.05804530e+00],
       [ 7.53777884e+00, -2.08446521e+00],
       [ 7.39643138e+00, -2.11314153e+00],
       [ 7.25581826e+00, -2.14403774e+00],
       [ 7.11603065e+00, -2.17733233e+00],
       [ 6.97712131e+00, -2.21314993e+00],
       [ 6.83917246e+00, -2.25171031e+00],
       [ 6.70224336e+00, -2.29316970e+00],
       [ 6.56642159e+00, -2.33776483e+00],
       [ 6.43173844e+00, -2.38557293e+00],
       [ 6.29818062e+00, -2.43654664e+00],
       [ 6.16569086e+00, -2.49051685e+00],
       [ 6.03416898e+00, -2.54719659e+00],
       [ 5.90347113e+00, -2.60617924e+00],
       [ 5.77345864e+00, -2.66707478e+00],
       [ 5.64403115e+00, -2.72960148e+00],
       [ 5.51513049e+00, -2.79359602e+00],
       [ 5.38356944e+00, -2.85729907e+00],
       [ 5.25144510e+00, -2.91946129e+00],
       [ 5.11867842e+00, -2.97982234e+00],
       [ 4.98516425e+00, -3.03802198e+00],
       [ 4.85087530e+00, -3.09390073e+00],
       [ 4.71574048e+00, -3.14714076e+00],
       [ 4.57969619e+00, -3.19740039e+00],
       [ 4.44271851e+00, -3.24441200e+00],
       [ 4.30482092e+00, -3.28797883e+00],
       [ 4.16605218e+00, -3.32797492e+00],
       [ 4.02649308e+00, -3.36434435e+00],
       [ 3.88625119e+00, -3.39709716e+00],
       [ 3.74545415e+00, -3.42630271e+00],
       [ 3.60424183e+00, -3.45208154e+00],
       [ 3.46275774e+00, -3.47459582e+00],
       [ 3.32113997e+00, -3.49403888e+00],
       [ 3.17951214e+00, -3.51062405e+00],
       [ 3.03797503e+00, -3.52457335e+00],
       [ 2.89659955e+00, -3.53610632e+00],
       [ 2.75542180e+00, -3.54542969e+00],
       [ 2.61444098e+00, -3.55272797e+00],
       [ 2.47362064e+00, -3.55815555e+00],
       [ 2.33289361e+00, -3.56183041e+00],
       [ 2.19217021e+00, -3.56382974e+00],
       [ 2.05134917e+00, -3.56418736e+00],
       [ 1.91033009e+00, -3.56289315e+00],
       [ 1.76902593e+00, -3.55989425e+00],
       [ 1.62737413e+00, -3.55509795e+00],
       [ 1.48534502e+00, -3.54837607e+00],
       [ 1.34294670e+00, -3.53957082e+00],
       [ 1.20022594e+00, -3.52850168e+00],
       [ 1.05726544e+00, -3.51497348e+00],
       [ 9.14177928e-01, -3.49878534e+00],
       [ 7.71097997e-01, -3.47974043e+00],
       [ 6.28172683e-01, -3.45765637e+00],
       [ 4.85551559e-01, -3.43237624e+00],
       [ 3.43377067e-01, -3.40377997e+00],
       [ 2.01775523e-01, -3.37179595e+00],
       [ 6.08491276e-02, -3.33641258e+00],
       [-7.93307528e-02, -3.29768896e+00],
       [-2.18728574e-01, -3.25576343e+00],
       [-3.57347166e-01, -3.21085745e+00],
       [-4.95227462e-01, -3.16327389e+00],
       [-6.32442001e-01, -3.11337858e+00],
       [-7.69069548e-01, -3.06152153e+00],
       [-9.05129887e-01, -3.00784520e+00],
       [-1.04061221e+00, -2.95242398e+00],
       [-1.17465976e+00, -2.89554935e+00],
       [-1.30832980e+00, -2.84125641e+00],
       [-1.44218081e+00, -2.78959312e+00],
       [-1.57644313e+00, -2.74072781e+00],
       [-1.71124079e+00, -2.69499038e+00],
       [-1.84665888e+00, -2.65279442e+00],
       [-1.98276149e+00, -2.61459254e+00],
       [-2.11959351e+00, -2.58082380e+00],
       [-2.25718376e+00, -2.55190044e+00],
       [-2.39554054e+00, -2.52816254e+00],
       [-2.53464843e+00, -2.50983979e+00],
       [-2.67446941e+00, -2.49703532e+00],
       [-2.81494692e+00, -2.48972469e+00],
       [-2.95601108e+00, -2.48776287e+00],
       [-3.09758424e+00, -2.49089595e+00],
       [-3.23958616e+00, -2.49877581e+00],
       [-3.38193844e+00, -2.51097599e+00],
       [-3.52456788e+00, -2.52700526e+00],
       [-3.66740868e+00, -2.54631554e+00],
       [-3.81040307e+00, -2.56829853e+00],
       [-3.95350041e+00, -2.59226734e+00],
       [-4.09666161e+00, -2.61757400e+00],
       [-4.23702260e+00, -2.64322169e+00],
       [-4.37689613e+00, -2.66684020e+00],
       [-4.51601708e+00, -2.68743099e+00],
       [-4.65410052e+00, -2.70403330e+00],
       [-4.79085256e+00, -2.71578902e+00],
       [-4.92597675e+00, -2.72196929e+00],
       [-5.05917143e+00, -2.72195509e+00],
       [-5.19012681e+00, -2.71521167e+00],
       [-5.31852586e+00, -2.70127328e+00],
       [-5.44404938e+00, -2.67973978e+00],
       [-5.56638585e+00, -2.65028430e+00],
       [-5.68524496e+00, -2.61266857e+00],
       [-5.80037333e+00, -2.56676024e+00],
       [-5.91157011e+00, -2.51254691e+00],
       [-6.01870096e+00, -2.45014369e+00],
       [-6.12170904e+00, -2.37979322e+00],
       [-6.22062248e+00, -2.30185862e+00],
       [-6.31555785e+00, -2.21681061e+00],
       [-6.40671942e+00, -2.12521113e+00],
       [-6.49439442e+00, -2.02769620e+00],
       [-6.57894507e+00, -1.92496181e+00],
       [-6.66079854e+00, -1.81775632e+00],
       [-6.74043963e+00, -1.70688623e+00],
       [-6.81841423e+00, -1.59324438e+00],
       [-6.89524013e+00, -1.47767994e+00],
       [-6.97139674e+00, -1.36098838e+00],
       [-7.05060816e+00, -1.23855964e+00],
       [-7.13024960e+00, -1.11644597e+00],
       [-7.21039471e+00, -9.94701384e-01],
       [-7.29106795e+00, -8.73343884e-01],
       [-7.37229701e+00, -7.52393817e-01],
       [-7.45405659e+00, -6.31832683e-01],
       [-7.53627658e+00, -5.11609125e-01],
       [-7.61890698e+00, -3.91686519e-01],
       [-7.70171350e+00, -2.71893064e-01],
       [-7.78466400e+00, -1.52205194e-01],
       [-7.86682177e+00, -3.39364187e-02],
       [-7.94813771e+00,  8.47418873e-02],
       [-8.02801234e+00,  2.04109977e-01],
       [-8.10577930e+00,  3.24461797e-01],
       [-8.18081977e+00,  4.46042210e-01],
       [-8.25255435e+00,  5.69045348e-01],
       [-8.32044479e+00,  6.93609810e-01],
       [-8.38399345e+00,  8.19816665e-01],
       [-8.44274096e+00,  9.47689977e-01],
       [-8.49626374e+00,  1.07719901e+00],
       [-8.54417236e+00,  1.20826161e+00],
       [-8.58611107e+00,  1.34074856e+00],
       [-8.62175846e+00,  1.47448888e+00],
       [-8.65082923e+00,  1.60927614e+00],
       [-8.67307678e+00,  1.74487547e+00],
       [-8.68829666e+00,  1.88103138e+00],
       [-8.69633058e+00,  2.01747606e+00],
       [-8.69707077e+00,  2.15393779e+00],
       [-8.69046440e+00,  2.29014946e+00],
       [-8.67651759e+00,  2.42585661e+00],
       [-8.65529857e+00,  2.56082493e+00],
       [-8.62693951e+00,  2.69484668e+00],
       [-8.59163660e+00,  2.82774594e+00],
       [-8.54964784e+00,  2.95938219e+00],
       [-8.50128847e+00,  3.08965202e+00],
       [-8.44692368e+00,  3.21848875e+00],
       [-8.38695898e+00,  3.34585969e+00],
       [-8.32182840e+00,  3.47176101e+00],
       [-8.25198114e+00,  3.59621037e+00],
       [-8.17786747e+00,  3.71923744e+00],
       [-8.09992477e+00,  3.84087301e+00],
       [-8.01856450e+00,  3.96113720e+00],
       [-7.93416087e+00,  4.08002793e+00],
       [-7.84704166e+00,  4.19751038e+00],
       [-7.75748158e+00,  4.31350866e+00],
       [-7.66569806e+00,  4.42790022e+00],
       [-7.57184947e+00,  4.54051358e+00],
       [-7.47603575e+00,  4.65112921e+00],
       [-7.37830120e+00,  4.75948349e+00],
       [-7.27863937e+00,  4.86527478e+00],
       [-7.17699989e+00,  4.96817143e+00],
       [-7.07329715e+00,  5.06782086e+00],
       [-6.96742021e+00,  5.16385958e+00],
       [-6.85924381e+00,  5.25592401e+00],
       [-6.74863965e+00,  5.34366182e+00],
       [-6.63548759e+00,  5.42674379e+00],
       [-6.51968588e+00,  5.50487560e+00],
       [-6.40116015e+00,  5.57780895e+00],
       [-6.27987046e+00,  5.64535105e+00],
       [-6.15581633e+00,  5.70737159e+00],
       [-6.02903938e+00,  5.76380637e+00],
       [-5.89962383e+00,  5.81465683e+00],
       [-5.76769506e+00,  5.85998545e+00],
       [-5.63341653e+00,  5.89990705e+00],
       [-5.49698572e+00,  5.93457663e+00],
       [-5.35862952e+00,  5.96417457e+00],
       [-5.21859954e+00,  5.98889039e+00],
       [-5.07720415e+00,  6.00905286e+00]])

def print_params(params):
    print(f"all_wheels_on_track: {params['all_wheels_on_track']}")
    print(f"x: {params['x']}")
    print(f"y: {params['y']}")
    print(f"closest_waypoints: {params['closest_waypoints']}")
    print(f"distance_from_center: {params['distance_from_center']}")
    print(f"is_left_of_center: {params['is_left_of_center']}")
    print(f"is_offtrack: {params['is_offtrack']}")
    print(f"is_reversed: {params['is_reversed']}")
    print(f"heading: {params['heading']}")
    print(f"progress: {params['progress']}")
    print(f"speed: {params['speed']}")
    print(f"steering_angle: {params['steering_angle']}")
    print(f"steps: {params['steps']}")

def calculate_heading_difference(params):
    
    closest_waypoints = params['closest_waypoints']
    heading = params['heading']
    cur_x = params['x']
    cur_y = params['y']
    
    # Calculate the direction of the center line based 
    current_opt_point = optimal_waypoints[closest_waypoints[0]]
    next_opt_point = optimal_waypoints[closest_waypoints[1]]
    future_opt_point_2 = optimal_waypoints[min(closest_waypoints[1]+1, len(optimal_waypoints)-1)]
    future_opt_point_3 = optimal_waypoints[min(closest_waypoints[1]+2, len(optimal_waypoints)-1)]
    future_opt_point_4 = optimal_waypoints[min(closest_waypoints[1]+3, len(optimal_waypoints)-1)]
    future_opt_point_5 = optimal_waypoints[min(closest_waypoints[1]+4, len(optimal_waypoints)-1)]
    
    FUTURE_POINTS_NUM = 5
    points = [next_opt_point, future_opt_point_2, future_opt_point_3, future_opt_point_4, future_opt_point_5]
    
    sum_of_angle = 0
    for i in range(FUTURE_POINTS_NUM):
        next_track_direction = math.atan2(points[i][1] - cur_y, points[i][0] - cur_x)
        next_track_angle = math.degrees(next_track_direction)
        optimal_heading_diff = next_track_angle - heading
        sum_of_angle += optimal_heading_diff
    sum_of_angle = abs(sum_of_angle/max(FUTURE_POINTS_NUM,2))
    
    return sum_of_angle

def reward_function(params):
    print_params(params)
    
    ### Initial reward
    reward = 10.0
    
    optimal_heading_diff = calculate_heading_difference(params)
    
    print(f'optimal_heading_diff: {optimal_heading_diff}')
    
    # give the reward
    if optimal_heading_diff > 30:
        reward *= 0.2
    elif optimal_heading_diff > 20:
        reward *= 0.5
    elif optimal_heading_diff > 15:
        reward *= 0.7
    elif optimal_heading_diff > 10:
        reward *= 1
    elif optimal_heading_diff > 5:
        reward *= 1.7
    elif optimal_heading_diff >= 0:
        reward *= 2.2
    
    return float(reward)